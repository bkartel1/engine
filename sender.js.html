<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: sender.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: sender.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

const EventEmitter = require('events').EventEmitter
const typeforce = require('./typeforce')
const pump = require('pump')
const thunky = require('thunky')
const through = require('through2')
const debug = require('debug')('tradle:sender')
const protocol = require('@tradle/protocol')
const topics = require('./topics')
const statuses = require('./status')
const types = require('./types')
const utils = require('./utils')
const controls = require('./controls')
const Channel = require('./channel')

module.exports = createSender

/**
 * message send with retry
 * @module sender
 * @typedef {sender}
 * @param {Object}        opts
 * @param {Function}      opts.send
 * @param {objectsDB}     opts.objects
 * @param {addressBook}   opts.addressBook
 * @param {Actions}       opts.actions
 * @param {Object}        opts.backoffOptions
 * @param {string}        [opts.name] (for logging)
 */
function createSender (opts) {
  typeforce({
    send: typeforce.Function,
    objects: typeforce.Object,
    addressBook: typeforce.Object,
    actions: typeforce.Object,
    backoffOptions: typeforce.maybe(typeforce.Object),
    name: typeforce.maybe(typeforce.String)
  }, opts)

  const myDebug = utils.subdebugger(debug, opts.name)
  const actions = opts.actions
  const objects = opts.objects
  const addressBook = opts.addressBook
  const send = opts.send
  const sender = new EventEmitter()
  sender.pause = function (recipient) {
    if (!recipient) return sender.pauseAll()
    if (!paused[recipient]) {
      paused[recipient] = true
      const channel = channels[recipient]
      if (channel) channel.destroy()
    }

    return sender.resume.bind(sender, recipient)
  }

  sender.pauseAll = function () {
    Object.keys(channels).forEach(recipient => channels[recipient].destroy())

    if (unsentStream) {
      unsentStream.destroy()
      unsentStream = null
    }

    return sender.resumeAll.bind(sender)
  }

  sender.resume = function (recipient) {
    if (!recipient) return sender.resumeAll()
    if (paused[recipient]) {
      delete paused[recipient]
      activateChannel(recipient)
    }
  }

  sender.start = start
  sender.stop = sender.pauseAll
  sender.resumeAll = start
  sender.isRunning = () => !!unsentStream

  let unsentStream
  let paused = {}
  const channels = {}
  return sender

  function normalizeRecipients (recipients) {
    return recipients ? [].concat(recipients) : Object.keys(recipientStreams)
  }

  function getChannels (recipients) {
    return recipients.map(rh => channels[rh])
      // filter out nulls
      .filter(stream => stream)
  }

  function activateChannel (permalink) {
    if (channels[permalink] || paused[permalink]) return

    const channelOpts = utils.extend({ recipient: permalink }, opts)
    const channel = channels[permalink] = new Channel(channelOpts)
    channel.once('destroy', () => delete channels[permalink])
    addressBook.byPermalink(permalink, function (err, recipientInfo) {
      if (err) return sender.emit('error', err)

      channel.setRecipient(recipientInfo)
      if (!paused[permalink]) channel.start()
    })
  }

  function start () {
    if (unsentStream) return

    paused = {}
    unsentStream = pump(
      objects.unsent({ live: true, keys: false, body: false }),
      through.obj(function (data, enc, cb) {
        activateChannel(data.recipient)
        cb()
      })
    )

    unsentStream.on('error', function (err) {
      myDebug('error in unsent messages stream: ' + err.stack)
      sender.emit('error', err)
    })

    return function stop () {
      unsentStream.end()

      for (let rh in channels) {
        channels[rh].destroy()
      }
    }
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-channel.html">channel</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-defaults.html">defaults</a></li><li><a href="module-errors.html">errors</a></li><li><a href="module-head.html">head</a></li><li><a href="module-manifest.html">manifest</a></li><li><a href="module-networks.html">networks</a></li><li><a href="module-protobufs.html">protobufs</a></li><li><a href="module-retrystream.html">retrystream</a></li><li><a href="module-sealer.html">sealer</a></li><li><a href="module-sealwatch.html">sealwatch</a></li><li><a href="module-status.html">status</a></li><li><a href="module-topics.html">topics</a></li><li><a href="module-typeforce.html">typeforce</a></li><li><a href="module-types.html">types</a></li><li><a href="module-utils.html">utils</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Aug 15 2016 00:24:34 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
