<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: dbs/watches.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: dbs/watches.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict'

/**
 * database for monitored addresses, bootstrapped from log
 * @module watchesDB
 */

const extend = require('xtend')
const collect = require('stream-collector')
const typeforce = require('../typeforce')
const subdown = require('subleveldown')
const debug = require('debug')('tradle:db:watches')
const indexer = require('feed-indexer')
const utils = require('../utils')
const topics = require('../topics')
const types = require('../types')
const statuses = require('../status')

/**
 * consumes txs, watches and:
 * 1. monitors/updates fulfilled watches
 * 2.
 * @param  {Object} opts
 * @param  {Object} opts.changes            changes-feed
 * @param  {Object} opts.db                 database to use to track seals
 * @param  {Number} opts.confirmedAfter     how many confirmations to wait for before the watch is complete
 */
module.exports = function createWatchesDB (opts) {
  typeforce({
    changes: types.changes,
    db: types.db,
    confirmedAfter: typeforce.maybe(typeforce.Number)
  }, opts)

  const confirmedAfter = opts.confirmedAfter
  const relevantTopics = [
    topics.newwatch,
    topics.readseal,
    // topics.newobj
  ]

  const indexedDB = indexer({
    feed: opts.changes,
    db: opts.db,
    primaryKey: calcPrimaryKey,
    filter: function (val) {
      return relevantTopics.indexOf(val.topic) !== -1
    },
    reduce: function (state, change, cb) {
      const changeVal = change.value
      if (state &amp;&amp; changeVal.confirmations >= confirmedAfter) {
        // delete
        debug(`deleting watch ${change.txId} after ${changeVal.confirmations} confirmations`)
        cb(null, null)
      } else {
        cb(null, indexedDB.merge(state, change))
      }
    }

    // custom: function (change, cb) {
    //   if (change.confirmations > 10) {

    //   }
    // },
    // reduce: function (state, change, cb) {
    //   const newState = indexedDB.merge(state, change)
    //   // console.log('state', state)
    //   // console.log('change', change)
    //   cb(null, newState)
    // }
  })

  const indexedProps = ['address', 'link', 'watchType', 'confirmations', 'blockHeight']
  const indexes = {}
  indexedProps.forEach(prop => indexes[prop] = indexedDB.by(prop))

  const ee = {}
  ee.findOne = function (prop, val, cb) {
    indexes[prop].findOne(val, cb)
  }

  ee.find = function (prop, val, cb) {
    indexes[prop].find(val, cb)
  }

  ee.get = function (opts, cb) {
    typeforce({
      address: typeforce.String,
      link: typeforce.String
    }, opts)

    const pKey = calcPrimaryKey(opts)
    indexedDB.get(pKey, cb)
  }

  ee.exists = function (opts, cb) {
    ee.get(opts, function (err, result) {
      cb(null, !!result)
    })
  }

  ee.createReadStream = indexedDB.createReadStream
  ee.list = function (cb) {
    return collect(indexedDB.createReadStream({ keys: false }), cb)
  }

  ee.follow = function () {
    return indexedDB.createReadStream({
      live: true,
      tail: true,
      old: false
    })
  }

  return ee

  function calcPrimaryKey (change) {
    let parts
    if (change.topic === topics.newwatch) {
      parts = [
        change.address,
        change.link
      ]
    } else {
      parts = [
        change.sealPrevAddress || change.sealAddress,
        change.prevLink || change.link
      ]
    }

    typeforce.arrayOf(typeforce.String, parts)
    return parts.join(indexedDB.separator)
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-actions.html">actions</a></li><li><a href="module-addressBook.html">addressBook</a></li><li><a href="module-channel.html">channel</a></li><li><a href="module-constants.html">constants</a></li><li><a href="module-controls.html">controls</a></li><li><a href="module-defaults.html">defaults</a></li><li><a href="module-head.html">head</a></li><li><a href="module-manifest.html">manifest</a></li><li><a href="module-networks.html">networks</a></li><li><a href="module-node.html">node</a></li><li><a href="module-objectsDB.html">objectsDB</a></li><li><a href="module-protobufs.html">protobufs</a></li><li><a href="module-retrystream.html">retrystream</a></li><li><a href="module-sealer.html">sealer</a></li><li><a href="module-sealsDB.html">sealsDB</a></li><li><a href="module-sealwatch.html">sealwatch</a></li><li><a href="module-sender.html">sender</a></li><li><a href="module-status.html">status</a></li><li><a href="module-topics.html">topics</a></li><li><a href="module-typeforce.html">typeforce</a></li><li><a href="module-types.html">types</a></li><li><a href="module-utils.html">utils</a></li><li><a href="module-validator.html">validator</a></li><li><a href="module-watchesDB.html">watchesDB</a></li></ul><h3>Classes</h3><ul><li><a href="module-channel-Channel.html">Channel</a></li><li><a href="module-node-Tradle.html">Tradle</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun Aug 14 2016 20:44:32 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
